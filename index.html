<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>City Check ‚Äî MiniApp (Dark)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#0f1113;
      --muted:#9aa0a6;
      --accent:#06b6a4;
      --text:#e6eef3;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#070708 0%, #0b0b0c 100%);color:var(--text);font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .wrap{max-width:920px;margin:0 auto;padding:16px;box-sizing:border-box;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    #backBtn{display:none;padding:8px 10px;background:rgba(255,255,255,0.03);border-radius:10px;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.6);font-weight:600}
    h1{font-size:18px;margin:0;font-weight:700;line-height:1.05}
    .subtitle{font-size:13px;color:var(--muted);margin-top:2px}

    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
    .card:active{transform:scale(.995)}
    .card .title{font-weight:700;font-size:14px}
    .card .hint{font-size:12px;color:var(--muted);margin-top:6px}

    /* Address list view */
    #searchWrap{display:none;margin-top:12px}
    #searchBox{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:var(--card);color:var(--text);box-sizing:border-box;font-size:15px}
    .list{margin-top:10px}
    .list-item{padding:12px;border-radius:12px;background:var(--glass);margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background .12s}
    .list-item:hover{background:rgba(255,255,255,0.02)}
    .name{font-size:15px}
    .tiny{font-size:12px;color:var(--muted)}

    /* Report form */
    .form-row{margin-top:12px}
    select, textarea, input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.035);background:var(--card);color:var(--text);box-sizing:border-box;font-size:14px}

    /* Photo area */
    .photo-row{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .photo-preview{width:96px;height:96px;border-radius:10px;overflow:hidden;background:#111;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
    .photo-preview img{width:100%;height:100%;object-fit:cover;display:block}
    .btn{padding:10px 12px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#03836f);color:#022;cursor:pointer;border:none;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--text)}

    .row{display:flex;gap:8px;align-items:center}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px;padding-bottom:20px}

    /* For small phones: compact */
    @media (max-width:420px){
      .wrap{padding:12px}
      h1{font-size:16px}
      .card .title{font-size:13px}
      #searchBox{padding:10px}
      .photo-preview{width:80px;height:80px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div id="backBtn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</div>
      <div>
        <h1 id="title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏</h1>
        <div class="subtitle" id="subtitle">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π ‚Äî —Ñ–æ—Ç–æ —Å timestamp</div>
      </div>
    </header>

    <!-- Search area (shown on addresses) -->
    <div id="searchWrap"><input id="searchBox" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å–∞–º‚Ä¶" oninput="onSearchInput()" /></div>

    <!-- Main content -->
    <div id="content">
      <div class="grid" id="startGrid">
        <div class="card" onclick="loadRegistry('–î–¢')"><div class="title">–î–¢ ‚Äî –î–≤–æ—Ä–æ–≤—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div><div class="hint">–ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–≤–æ—Ä–æ–≤</div></div>
        <div class="card" onclick="loadRegistry('–û–î–•')"><div class="title">–û–î–• ‚Äî –û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</div><div class="hint">–ü–∞—Ä–∫–∏ –∏ –∫–ª—É–º–±—ã</div></div>
        <div class="card" onclick="openExtra('–í–Ω–µ—É–ª–ü–µ—Ä–µ—Ö–æ–¥—ã')"><div class="title">–í–Ω–µ—É–ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</div></div>
        <div class="card" onclick="openExtra('–ú–æ—Å—Ç—ã')"><div class="title">–ú–æ—Å—Ç—ã</div></div>
        <div class="card" onclick="openExtra('–¢–µ—Ö–Ω–∏–∫–∞')"><div class="title">–¢–µ—Ö–Ω–∏–∫–∞</div></div>
        <div class="card" onclick="openExtra('–¶–≤–µ—Ç–Ω–∏–∫–∏')"><div class="title">–¶–≤–µ—Ç–Ω–∏–∫–∏</div></div>
      </div>
    </div>

    <!-- Hidden file input -->
    <input id="fileInput" accept="image/*" type="file" style="display:none" />

    <footer>–†–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram Mini App –∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –§–æ—Ç–æ –ø–æ–ª—É—á–∞—é—Ç timestamp –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.</footer>
  </div>

<script>
/* ====== Globals ====== */
let registry = {};
let selectedType = "";
let selectedOkrug = "";
let selectedBalance = "";
let addressList = [];
let currentPreviewDataUrl = "";
let lastSearchTimer = null;

const content = document.getElementById('content');
const backBtn = document.getElementById('backBtn');
const titleEl = document.getElementById('title');
const searchWrap = document.getElementById('searchWrap');
const searchBox = document.getElementById('searchBox');
const fileInput = document.getElementById('fileInput');

/* ====== Helpers ====== */
function showBack(on){ backBtn.style.display = on ? 'block' : 'none'; }
function setTitle(t){ titleEl.textContent = t; }
function escapeHtml(text){ return (''+text).replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function getQueryParam(name){ return new URLSearchParams(location.search).get(name); }

/* ====== Navigation ====== */
function goBack(){
  if (!selectedType) return;
  if (document.getElementById('addrList')) { showBalances(); return; } // were in addresses
  if (selectedBalance) { selectedBalance = ""; showBalances(); return; }
  if (selectedOkrug) { selectedOkrug = ""; showOkrugs(); return; }
  // root
  selectedType = ""; registry = {}; addressList = []; selectedOkrug = ""; selectedBalance = "";
  showStart();
}

function showStart(){
  showBack(false);
  setTitle('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏');
  searchWrap.style.display='none';
  content.innerHTML = `
    <div class="grid" id="startGrid">
      <div class="card" onclick="loadRegistry('–î–¢')"><div class="title">–î–¢ ‚Äî –î–≤–æ—Ä–æ–≤—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div><div class="hint">–ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–≤–æ—Ä–æ–≤</div></div>
      <div class="card" onclick="loadRegistry('–û–î–•')"><div class="title">–û–î–• ‚Äî –û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</div><div class="hint">–ü–∞—Ä–∫–∏ –∏ –∫–ª—É–º–±—ã</div></div>
      <div class="card" onclick="openExtra('–í–Ω–µ—É–ª–ü–µ—Ä–µ—Ö–æ–¥—ã')"><div class="title">–í–Ω–µ—É–ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</div></div>
      <div class="card" onclick="openExtra('–ú–æ—Å—Ç—ã')"><div class="title">–ú–æ—Å—Ç—ã</div></div>
      <div class="card" onclick="openExtra('–¢–µ—Ö–Ω–∏–∫–∞')"><div class="title">–¢–µ—Ö–Ω–∏–∫–∞</div></div>
      <div class="card" onclick="openExtra('–¶–≤–µ—Ç–Ω–∏–∫–∏')"><div class="title">–¶–≤–µ—Ç–Ω–∏–∫–∏</div></div>
    </div>
  `;
}

/* ====== Load registry JSON ====== */
async function loadRegistry(type){
  selectedType = type;
  const path = (type === '–î–¢') ? '/data/dt.json' : '/data/odh.json';
  setTitle('–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞...');
  try {
    const res = await fetch(path, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    registry = await res.json();
    selectedOkrug = ""; selectedBalance = ""; addressList = [];
    showOkrugs();
  } catch(err){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞: ' + err.message + '. –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å /data/dt.json –∏ /data/odh.json –∏ –ø–æ–¥–æ–∂–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GitHub Pages.');
    showStart();
  }
}

/* ====== Okrugs ====== */
function showOkrugs(){
  showBack(true);
  setTitle(selectedType + ' ‚Üí –í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–≥');
  searchWrap.style.display='none';
  const okrugs = Object.keys(registry).sort();
  const html = `<div class="list" id="okrugsList">${okrugs.map(o => `<div class="list-item" data-ok="${escapeHtml(o)}"><div class="name">${o}</div><div class="tiny">‚Üí</div></div>`).join('')}</div>`;
  content.innerHTML = html;
  document.querySelectorAll('#okrugsList .list-item').forEach(el => el.onclick = () => { selectedOkrug = el.dataset.ok; showBalances(); });
}

/* ====== Balances ====== */
function showBalances(){
  showBack(true);
  setTitle(selectedType + ' ‚Üí ' + selectedOkrug + ' ‚Üí –ë–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å');
  searchWrap.style.display='none';
  const balances = Object.keys(registry[selectedOkrug]||{}).sort();
  const html = `<div class="list" id="balancesList">${balances.map(b => `<div class="list-item" data-b="${escapeHtml(b)}"><div class="name">${b}</div><div class="tiny">${(registry[selectedOkrug][b]||[]).length} –∞–¥—Ä–µ—Å–æ–≤</div></div>`).join('')}</div>`;
  content.innerHTML = html;
  document.querySelectorAll('#balancesList .list-item').forEach(el => el.onclick = () => { selectedBalance = el.dataset.b; addressList = registry[selectedOkrug][selectedBalance] || []; showAddresses(); });
}

/* ====== Addresses (with search) ====== */
function showAddresses(){
  showBack(true);
  setTitle(selectedType + ' ‚Üí ' + selectedOkrug + ' ‚Üí ' + selectedBalance);
  searchWrap.style.display='block';
  searchBox.value = '';
  content.innerHTML = `<div id="addrList" class="list"></div>`;
  renderAddresses(addressList);
  // put focus on search on mobile after a small delay
  setTimeout(()=>{ searchBox.focus(); }, 150);
}

function renderAddresses(list){
  const listEl = document.getElementById('addrList');
  listEl.innerHTML = '';
  if (!list || !list.length) { listEl.innerHTML = '<div class="tiny">–ê–¥—Ä–µ—Å–æ–≤ –Ω–µ—Ç.</div>'; return; }
  list.forEach(addr => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `<div class="name">${addr}</div><div class="tiny">‚Üí</div>`;
    div.onclick = () => openReportForm(addr);
    listEl.appendChild(div);
  });
}

/* Debounced search handler */
function onSearchInput(){
  clearTimeout(lastSearchTimer);
  lastSearchTimer = setTimeout(() => {
    const q = searchBox.value.trim().toLowerCase();
    const filtered = addressList.filter(a => a.toLowerCase().includes(q));
    renderAddresses(filtered);
  }, 180);
}

/* ====== Report form ====== */
function openReportForm(addr){
  setTitle('–ù–∞—Ä—É—à–µ–Ω–∏–µ: ' + addr);
  searchWrap.style.display='none';
  content.innerHTML = `
    <div style="margin-top:6px" class="tiny">–ê–¥—Ä–µ—Å: <strong>${addr}</strong></div>

    <div class="form-row">
      <label class="tiny">–¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è</label>
      <select id="violationType">
        <option>–ú—É—Å–æ—Ä</option>
        <option>–°–ª–æ–º–∞–Ω–Ω—ã–µ –ª–∞–≤–æ—á–∫–∏</option>
        <option>–Ø–º—ã/–ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π –∞—Å—Ñ–∞–ª—å—Ç</option>
        <option>–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</option>
        <option>–ü—Ä–æ–±–ª–µ–º—ã –Ω–∞ –¥–µ—Ç—Å–∫–æ–π –ø–ª–æ—â–∞–¥–∫–µ</option>
        <option>–û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</option>
        <option>–î—Ä—É–≥–æ–µ</option>
      </select>
    </div>

    <div class="form-row">
      <label class="tiny">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"></textarea>
    </div>

    <div class="photo-row">
      <div class="photo-preview" id="photoPreview"><div class="tiny">–§–æ—Ç–æ –Ω–µ—Ç</div></div>
      <div style="flex:1;min-width:160px">
        <div class="row">
          <button class="btn" onclick="triggerCamera()">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
          <button class="btn ghost" onclick="triggerGallery()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div style="margin-top:8px" class="row">
          <button class="btn ghost" onclick="getCoords()">üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
          <button class="btn" onclick="sendReport('${escapeHtml(addr)}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div id="coordText" class="tiny" style="margin-top:8px;color:var(--muted)"></div>
      </div>
    </div>
    <div style="margin-top:8px" class="tiny">–§–æ—Ç–æ —Å timestamp (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è) –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ª–æ–∂–µ–Ω–æ –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É.</div>
  `;
  currentPreviewDataUrl = "";
}

/* ====== Camera & Gallery ====== */
/* iOS note: iOS Safari may ignore capture attribute and open chooser ‚Äî that's expected. */
function triggerCamera(){
  fileInput.setAttribute('accept','image/*');
  fileInput.setAttribute('capture','environment'); // ask for back camera
  fileInput.click();
}
function triggerGallery(){
  fileInput.removeAttribute('capture');
  fileInput.setAttribute('accept','image/*');
  fileInput.click();
}

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  try {
    const dataUrl = await readFileAsDataURL(file);
    const watermarked = await addTimestampToImage(dataUrl);
    currentPreviewDataUrl = watermarked;
    showPreviewImage(watermarked);
  } catch(err){
    alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: ' + err.message);
  } finally {
    fileInput.value = ''; // reset so same file can be reselected
  }
});

function readFileAsDataURL(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

function showPreviewImage(dataUrl){
  const prev = document.getElementById('photoPreview');
  prev.innerHTML = `<img src="${dataUrl}" alt="photo" />`;
  // optional: tap to open in new tab
  prev.onclick = () => {
    const w = window.open();
    w.document.write('<img src="'+dataUrl+'" style="max-width:100%"/>');
  };
}

/* ====== Draw timestamp on image (canvas) ====== */
async function addTimestampToImage(dataUrl){
  return new Promise((res, rej) => {
    const img = new Image();
    img.onload = () => {
      try {
        // Respect device pixel ratio for drawing clarity
        const dpr = Math.min(window.devicePixelRatio || 1, 2);
        // Resize large images to a reasonable max width for upload
        const maxW = 1400;
        let w = img.width, h = img.height;
        if (w > maxW) {
          const r = maxW / w;
          w = Math.round(w * r);
          h = Math.round(h * r);
        }
        const canvas = document.createElement('canvas');
        canvas.width = w * dpr;
        canvas.height = h * dpr;
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.drawImage(img, 0, 0, w, h);

        // Timestamp text (device local time)
        const now = new Date();
        const ts = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate())
                  + ' ' + pad(now.getHours()) + ':' + pad(now.getMinutes());

        // Font and metrics
        const fontSize = Math.max(12, Math.round(w * 0.03)); // responsive
        ctx.font = `${fontSize}px -apple-system, Roboto, Arial`;
        ctx.textBaseline = 'bottom';
        const textMetrics = ctx.measureText(ts);
        const textW = textMetrics.width;
        const padding = Math.round(fontSize * 0.6);

        // Coordinates for box & text (right-bottom)
        const x = w - textW - padding - 10;
        const y = h - 10;

        // Draw dark semi-transparent box with rounded corners
        const boxW = textW + padding*2;
        const boxH = fontSize + padding*0.6;
        const boxX = x - padding;
        const boxY = y - boxH + 6;

        // rounded rect
        roundRect(ctx, boxX, boxY, boxW, boxH, Math.max(6, Math.round(fontSize*0.3)), 'rgba(0,0,0,0.45)');

        // Text
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        ctx.fillText(ts, x, y - 6);

        // Export JPEG compressed
        const out = canvas.toDataURL('image/jpeg', 0.82);
        res(out);
      } catch(e){
        rej(e);
      }
    };
    img.onerror = () => rej(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç)'));
    img.src = dataUrl;
  });
}

function roundRect(ctx, x, y, w, h, r, fillStyle){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
  ctx.fillStyle = fillStyle;
  ctx.fill();
}

function pad(n){ return (n < 10 ? '0' : '') + n; }

/* ====== Geolocation ====== */
function getCoords(){
  const coordText = document.getElementById('coordText');
  coordText.textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...';
  if (!navigator.geolocation) { coordText.textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'; return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);
    coordText.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ' + lat + ',' + lon;
  }, err => {
    coordText.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
  }, { enableHighAccuracy:true, timeout:10000 });
}

/* ====== Send report ====== */
async function sendReport(addr){
  const violation = document.getElementById('violationType').value;
  const comment = document.getElementById('comment').value;
  const coords = (document.getElementById('coordText').textContent || '').replace('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ','');
  if (!currentPreviewDataUrl) { alert('–î–æ–±–∞–≤—å —Ñ–æ—Ç–æ'); return; }

  const payload = {
    timestamp: new Date().toISOString(),
    type: selectedType,
    okrug: selectedOkrug,
    balance: selectedBalance,
    address: addr,
    violation,
    comment,
    coords,
    photo_base64: currentPreviewDataUrl // data URL (jpeg)
  };

  const webhook = getQueryParam('webhook') || '';
  if (!webhook) {
    console.log('Payload (test):', payload);
    alert('–î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ (—Ç–µ—Å—Ç). –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –¥–æ–±–∞–≤—å ?webhook=YOUR_URL –≤ –∞–¥—Ä–µ—Å –º–∏–Ω–∏-–∞–ø–ø–∞.');
    return;
  }

  try {
    const res = await fetch(webhook, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json().catch(()=>({status:'ok'}));
    alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ' + (json.status || 'ok'));
    goBack();
  } catch(err){
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
  }
}

/* ====== Utility: open extra placeholders ====== */
function openExtra(name){ alert('–†–∞–∑–¥–µ–ª ¬´' + name + '¬ª –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ú–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å.'); }

/* ====== Init ====== */
showStart();

/* ====== Expose small helpers for console debugging ====== */
window._miniapp = { loadRegistry, showStart, showOkrugs, showBalances, showAddresses };

</script>
</body>
</html>
