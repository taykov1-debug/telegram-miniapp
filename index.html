<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>City Check MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f2f2f7;
      padding: 20px;
    }

    h2 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .card {
      background: #fff;
      padding: 18px 20px;
      border-radius: 16px;
      margin-bottom: 12px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .card:active {
      transform: scale(.97);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #backBtn {
      display: none;
      margin-bottom: 15px;
      padding: 12px 16px;
      background: white;
      border-radius: 12px;
      width: fit-content;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      cursor: pointer;
      font-size: 16px;
    }

    #searchBox {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 15px;
      border-radius: 14px;
      border: 1px solid #d2d2d7;
      font-size: 17px;
      display: none;
    }
  </style>
</head>

<body>

  <div id="backBtn" onclick="goBack()">← Назад</div>

  <h2 id="title">Выберите тип проверки</h2>

  <input id="searchBox" placeholder="Поиск адреса…" oninput="filterAddresses()">

  <div id="content"></div>

<script>
let step = "type";
let selectedType = "";
let selectedOkrug = "";
let selectedBalance = "";
let registry = {};

function showBack(show) {
    document.getElementById("backBtn").style.display = show ? "block" : "none";
}

function setTitle(text) {
    document.getElementById("title").textContent = text;
}

function clearContent() {
    document.getElementById("content").innerHTML = "";
}

function createCard(text, onclick) {
    const div = document.createElement("div");
    div.className = "card";
    div.textContent = text;
    div.onclick = onclick;
    return div;
}

function goBack() {
    if (step === "okrug") {
        step = "type";
        showStartMenu();
    } else if (step === "balance") {
        step = "okrug";
        showOkrugs();
    } else if (step === "address") {
        step = "balance";
        showBalances();
    }
}

function showStartMenu() {
    showBack(false);
    document.getElementById("searchBox").style.display = "none";
    setTitle("Выберите тип проверки");
    clearContent();

    const list = [
        ["ДТ", "data/dt.json"],
        ["ОДХ", "data/odh.json"]
    ];

    list.forEach(item => {
        content.appendChild(createCard(item[0], () => loadRegistry(item[0], item[1])));
    });
}

async function loadRegistry(type, path) {
    selectedType = type;

    const response = await fetch(path);
    registry = await response.json();

    step = "okrug";
    showOkrugs();
}

function showOkrugs() {
    showBack(true);
    document.getElementById("searchBox").style.display = "none";

    setTitle("Выберите округ");
    clearContent();

    Object.keys(registry).forEach(ok => {
        content.appendChild(createCard(ok, () => {
            selectedOkrug = ok;
            step = "balance";
            showBalances();
        }));
    });
}

function showBalances() {
    showBack(true);
    document.getElementById("searchBox").style.display = "none";

    setTitle(selectedOkrug + " → Балансодержатель");
    clearContent();

    Object.keys(registry[selectedOkrug]).forEach(bal => {
        content.appendChild(createCard(bal, () => {
            selectedBalance = bal;
            step = "address";
            showAddresses();
        }));
    });
}

let addressList = [];

function showAddresses() {
    showBack(true);
    setTitle(selectedOkrug + " → " + selectedBalance + "\nВыберите адрес");

    document.getElementById("searchBox").style.display = "block";

    clearContent();

    addressList = registry[selectedOkrug][selectedBalance];

    renderAddressList(addressList);
}

function renderAddressList(list) {
    clearContent();
    list.forEach(addr => {
        content.appendChild(createCard(addr, () => {
            Telegram.WebApp.close(); 
        }));
    });
}

function filterAddresses() {
    const q = document.getElementById("searchBox").value.toLowerCase().trim();
    const filtered = addressList.filter(a => a.toLowerCase().includes(q));
    renderAddressList(filtered);
}

showStartMenu();
</script>

</body>
</html>
