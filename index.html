<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>City Check</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial;
      background: #f1f3f5;
      padding: 20px;
    }

    h2 {
      margin-top: 0;
    }

    .card {
      background: #fff;
      padding: 15px 18px;
      border-radius: 14px;
      margin-bottom: 14px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.07);
      cursor: pointer;
      transition: 0.15s;
      font-size: 18px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.10);
    }

    .hidden {
      display: none;
    }

    #searchBox {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #bbb;
      margin-bottom: 15px;
      font-size: 16px;
      outline: none;
    }

    #searchBox:focus {
      border-color: #4a90e2;
    }
  </style>
</head>

<body>

  <h2 id="title">Выберите тип проверки</h2>
  <div id="list"></div>

  <input id="searchBox" class="hidden" placeholder="Поиск адреса..." oninput="filterAddresses()" />

  <script>
    const listEl = document.getElementById("list");
    const titleEl = document.getElementById("title");
    const searchBox = document.getElementById("searchBox");

    let currentType = null;
    let registryData = {};
    let selectedOkrug = null;
    let selectedBalance = null;
    let addresses = [];

    start();

    function start() {
      titleEl.textContent = "Выберите тип проверки";
      searchBox.classList.add("hidden");
      render([
        { id: "dt", name: "Дворовые территории" },
        { id: "odh", name: "ОДХ" },
      ], selectType);
    }

    function render(items, handler) {
      listEl.innerHTML = "";
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = item.name;
        div.onclick = () => handler(item.id || item.name, item.name);
        listEl.appendChild(div);
      });
    }

    async function selectType(type) {
      currentType = type;
      titleEl.textContent = "Загрузка реестра...";

      const url = type === "dt" ? "data/dt.json" : "data/odh.json";
      registryData = await fetch(url).then(r => r.json());

      showOkrugs();
    }

    function showOkrugs() {
      titleEl.textContent = "Выберите округ";
      searchBox.classList.add("hidden");

      const items = Object.keys(registryData).map(ok => ({
        id: ok,
        name: ok
      }));

      render(items, selectOkrug);
    }

    function selectOkrug(ok) {
      selectedOkrug = ok;
      const balances = registryData[ok];

      titleEl.textContent = "Выберите балансодержателя";

      const items = Object.keys(balances).map(b => ({
        id: b,
        name: b
      }));

      render(items, selectBalance);
    }

    function selectBalance(bal) {
      selectedBalance = bal;
      addresses = registryData[selectedOkrug][selectedBalance];

      titleEl.textContent = "Выберите адрес";
      searchBox.classList.remove("hidden");

      renderAddresses(addresses);
    }

    function renderAddresses(list) {
      listEl.innerHTML = "";

      list.forEach(addr => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = addr;
        div.onclick = () => submitAddress(addr);
        listEl.appendChild(div);
      });
    }

    function filterAddresses() {
      const term = searchBox.value.toLowerCase();
      const filtered = addresses.filter(a => a.toLowerCase().includes(term));
      renderAddresses(filtered);
    }

    function submitAddress(addr) {
      Telegram.WebApp.close();
    }
  </script>
</body>
</html>
