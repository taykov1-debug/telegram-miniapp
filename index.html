<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>City Check ‚Äî MiniApp (Dark)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0b0c;
      --card:#0f1113;
      --muted:#9aa0a6;
      --accent:#0ea5a1;
      --text:#e6eef3;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#070708 0%, #0b0b0c 100%);color:var(--text);font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;}
    .wrap{max-width:980px;margin:12px auto;padding:calc(env(safe-area-inset-top) + 14px) 14px 24px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    #backBtn{display:none;padding:8px 12px;background:var(--card);border-radius:10px;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.6);font-weight:600}
    h1{font-size:18px;margin:0;font-weight:700}
    .subtitle{font-size:13px;color:var(--muted);margin-top:4px}

    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(2,6,23,0.6);cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .card:active{transform:scale(.995)}
    .card .title{font-weight:600;font-size:15px}
    .card .hint{font-size:12px;color:var(--muted);margin-top:6px}

    #searchBox{display:none;width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:var(--card);color:var(--text);box-sizing:border-box;margin:14px 0;font-size:15px}
    .list{margin-top:8px}
    .list-item{padding:10px 12px;border-radius:10px;background:var(--glass);margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .list-item .name{font-size:15px}
    .tiny{font-size:12px;color:var(--muted)}

    /* Photo area */
    .photo-row{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .photo-preview{width:110px;height:110px;border-radius:8px;overflow:hidden;background:#111;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
    .photo-preview img{width:100%;height:100%;object-fit:cover;display:block}
    .btn{padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#0ea5a1,#049386);color:#042;cursor:pointer;border:none;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    @media (max-width:420px){
      .grid{grid-template-columns:repeat(2,1fr)}
      .wrap{padding:calc(env(safe-area-inset-top) + 10px) 12px 20px}
      h1{font-size:16px}
      #searchBox{font-size:14px}
      .photo-preview{width:86px;height:86px}
    }

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div id="backBtn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</div>
      <div style="flex:1">
        <h1 id="title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏</h1>
        <div class="subtitle" id="subtitle">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π ‚Äî —Ñ–æ—Ç–æ —Å timestamp</div>
      </div>
    </header>

    <input id="searchBox" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å–∞–º‚Ä¶" oninput="filterAddresses()" autocomplete="off" />

    <div id="content">
      <div class="grid" id="startGrid">
        <div class="card" onclick="loadRegistry('–î–¢')"><div class="title">–î–¢ ‚Äî –î–≤–æ—Ä–æ–≤—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div><div class="hint">–ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–≤–æ—Ä–æ–≤</div></div>
        <div class="card" onclick="loadRegistry('–û–î–•')"><div class="title">–û–î–• ‚Äî –û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</div><div class="hint">–ü–∞—Ä–∫–∏ –∏ –∫–ª—É–º–±—ã</div></div>
        <div class="card" onclick="openExtra('–í–Ω–µ—É–ª–ü–µ—Ä–µ—Ö–æ–¥—ã')"><div class="title">–í–Ω–µ—É–ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</div></div>
        <div class="card" onclick="openExtra('–ú–æ—Å—Ç—ã')"><div class="title">–ú–æ—Å—Ç—ã</div></div>
        <div class="card" onclick="openExtra('–¢–µ—Ö–Ω–∏–∫–∞')"><div class="title">–¢–µ—Ö–Ω–∏–∫–∞</div></div>
        <div class="card" onclick="openExtra('–¶–≤–µ—Ç–Ω–∏–∫–∏')"><div class="title">–¶–≤–µ—Ç–Ω–∏–∫–∏</div></div>
      </div>
    </div>

    <!-- hidden input -->
    <input id="fileInput" accept="image/*" type="file" style="display:none"/>

    <footer>–†–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –≤ Telegram Mini App. –§–æ—Ç–æ –ø–æ–ª—É—á–∞—é—Ç timestamp –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.</footer>
  </div>

<script>
/* ===== Globals ===== */
let registry = {};
let selectedType = "";
let selectedOkrug = "";
let selectedBalance = "";
let addressList = [];
let currentPreviewDataUrl = "";

const content = document.getElementById('content');
const backBtn = document.getElementById('backBtn');
const titleEl = document.getElementById('title');
const searchBox = document.getElementById('searchBox');
const fileInput = document.getElementById('fileInput');
const telegram = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

/* Platform detect */
const ua = navigator.userAgent || '';
function isIOS(){ return /iPad|iPhone|iPod/.test(ua) && !window.MSStream; }
function isAndroid(){ return /Android/.test(ua); }

/* UI helpers */
function showBack(on){ backBtn.style.display = on ? 'inline-block' : 'none'; }
function setTitle(t){ titleEl.textContent = t; }

function goBack(){
  if (!selectedType) return;
  if (searchBox.style.display === 'block' && addressList.length) { showBalances(); return; }
  if (selectedBalance) { selectedBalance = ""; showBalances(); return; }
  if (selectedOkrug) { selectedOkrug = ""; showOkrugs(); return; }
  // root
  selectedType = "";
  registry = {};
  addressList = [];
  selectedOkrug = "";
  selectedBalance = "";
  showStart();
}

/* Start */
function showStart(){
  showBack(false);
  setTitle("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏");
  searchBox.style.display = 'none';
  content.innerHTML = `
    <div class="grid" id="startGrid">
      <div class="card" onclick="loadRegistry('–î–¢')"><div class="title">–î–¢ ‚Äî –î–≤–æ—Ä–æ–≤—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div><div class="hint">–ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–≤–æ—Ä–æ–≤</div></div>
      <div class="card" onclick="loadRegistry('–û–î–•')"><div class="title">–û–î–• ‚Äî –û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</div><div class="hint">–ü–∞—Ä–∫–∏ –∏ –∫–ª—É–º–±—ã</div></div>
      <div class="card" onclick="openExtra('–í–Ω–µ—É–ª–ü–µ—Ä–µ—Ö–æ–¥—ã')"><div class="title">–í–Ω–µ—É–ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</div></div>
      <div class="card" onclick="openExtra('–ú–æ—Å—Ç—ã')"><div class="title">–ú–æ—Å—Ç—ã</div></div>
      <div class="card" onclick="openExtra('–¢–µ—Ö–Ω–∏–∫–∞')"><div class="title">–¢–µ—Ö–Ω–∏–∫–∞</div></div>
      <div class="card" onclick="openExtra('–¶–≤–µ—Ç–Ω–∏–∫–∏')"><div class="title">–¶–≤–µ—Ç–Ω–∏–∫–∏</div></div>
      <div class="card" onclick="openExtra('–•—É–π —Å–æ—Å–∏')"><div class="title">–•—É–π —Å–æ—Å–∏</div></div>
    </div>
  `;
}

/* Load registry (dt/odh) from /data/ ‚Äî —É–±–µ–¥–∏—Å—å, —á—Ç–æ dt.json/odh.json –≤ /data/ (–∫–∞–∫ –≤ —Ä–µ–ø–æ). */
async function loadRegistry(type){
  selectedType = type;
  const ROOT = "https://taykov1-debug.github.io/telegram-miniapp";

const path = type === '–î–¢'
  ? ROOT + "/data/dt.json"
  : ROOT + "/data/odh.json";
  setTitle('–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞...');
  try {
    const res = await fetch(path, {cache:'no-cache'});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    registry = await res.json();
    selectedOkrug = "";
    selectedBalance = "";
    addressList = [];
    showOkrugs();
  } catch(e){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞: ' + e.message + '. –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å /data/ –∏ –Ω–∞–ª–∏—á–∏–µ dt.json/odh.json.');
    showStart();
  }
}

/* Show okrugs */
function showOkrugs(){
  showBack(true);
  setTitle(`${selectedType} ‚Üí –í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–≥`);
  searchBox.style.display = 'none';
  content.innerHTML = '<div class="list"></div>';
  const listEl = content.querySelector('.list');
  const okrugs = Object.keys(registry).sort();
  if (okrugs.length === 0) {
    listEl.innerHTML = '<div class="tiny">–û–∫—Ä—É–≥–æ–≤ –Ω–µ—Ç –≤ —Ä–µ–µ—Å—Ç—Ä–µ.</div>';
    return;
  }
  okrugs.forEach(ok => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `<div class="name">${ok}</div><div class="tiny">‚Üí</div>`;
    div.onclick = () => { selectedOkrug = ok; showBalances(); };
    listEl.appendChild(div);
  });
}

/* Show balances */
function showBalances(){
  showBack(true);
  setTitle(`${selectedType} ‚Üí ${selectedOkrug} ‚Üí –ë–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å`);
  searchBox.style.display = 'none';
  content.innerHTML = '<div class="list"></div>';
  const listEl = content.querySelector('.list');
  const balances = Object.keys(registry[selectedOkrug] || {}).sort();
  if (balances.length === 0){ listEl.innerHTML = '<div class="tiny">–ë–∞–ª–∞–Ω—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª–µ–π –Ω–µ—Ç.</div>'; return; }
  balances.forEach(b => {
    const div = document.createElement('div');
    div.className = 'list-item';
    const count = (registry[selectedOkrug][b]||[]).length;
    div.innerHTML = `<div class="name">${b}</div><div class="tiny">${count} –∞–¥—Ä–µ—Å–æ–≤</div>`;
    div.onclick = () => { selectedBalance = b; addressList = registry[selectedOkrug][b] || []; showAddresses(); };
    listEl.appendChild(div);
  });
}

/* Show addresses with search */
function showAddresses(){
  showBack(true);
  setTitle(`${selectedType} ‚Üí ${selectedOkrug} ‚Üí ${selectedBalance}`);
  searchBox.style.display = 'block';
  searchBox.value = '';
  content.innerHTML = `
    <div id="addrList" class="list"></div>
    <div style="margin-top:8px" id="addressActions"></div>
  `;
  renderAddresses(addressList);
}

function renderAddresses(list){
  const listEl = document.getElementById('addrList');
  listEl.innerHTML = '';
  if (!list || list.length === 0){ listEl.innerHTML = '<div class="tiny">–ê–¥—Ä–µ—Å–æ–≤ –Ω–µ—Ç.</div>'; return; }
  list.forEach(addr => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `<div class="name">${addr}</div><div class="tiny">‚Üí</div>`;
    div.onclick = () => openReportForm(addr);
    listEl.appendChild(div);
  });
}

function filterAddresses(){
  const q = searchBox.value.trim().toLowerCase();
  const filtered = addressList.filter(a => a.toLowerCase().includes(q));
  renderAddresses(filtered);
}

/* Open report form */
function openReportForm(addr){
  setTitle('–ù–∞—Ä—É—à–µ–Ω–∏–µ: ' + addr);
  searchBox.style.display = 'none';
  showBack(true);
  content.innerHTML = `
    <div style="margin-top:6px" class="tiny">–ê–¥—Ä–µ—Å: <strong>${escapeHtml(addr)}</strong></div>
    <div style="margin-top:12px">
      <label class="tiny">–¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è</label>
      <select id="violationType" style="width:100%;padding:10px;border-radius:10px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,0.03)">
        <option>–ú—É—Å–æ—Ä</option>
        <option>–°–ª–æ–º–∞–Ω–Ω—ã–µ –ª–∞–≤–æ—á–∫–∏</option>
        <option>–Ø–º—ã/–ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π –∞—Å—Ñ–∞–ª—å—Ç</option>
        <option>–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</option>
        <option>–ü—Ä–æ–±–ª–µ–º—ã –Ω–∞ –¥–µ—Ç—Å–∫–æ–π –ø–ª–æ—â–∞–¥–∫–µ</option>
        <option>–û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ</option>
        <option>–î—Ä—É–≥–æ–µ</option>
      </select>
    </div>
    <div style="margin-top:10px">
      <label class="tiny">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" style="width:100%;min-height:80px;padding:10px;border-radius:10px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,0.03)"></textarea>
    </div>

    <div class="photo-row">
      <div class="photo-preview" id="photoPreview"><div class="tiny">–§–æ—Ç–æ –Ω–µ—Ç</div></div>
      <div style="flex:1;min-width:180px">
        <div class="row">
          <button class="btn" id="cameraBtn">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
          <button class="btn ghost" id="galleryBtn">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div style="margin-top:8px" class="row">
          <button class="btn ghost" id="coordsBtn">üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
          <button class="btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div id="coordText" class="tiny" style="margin-top:8px;color:var(--muted)"></div>
      </div>
    </div>
    <div style="margin-top:8px" class="tiny">–§–æ—Ç–æ —Å timestamp (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ª–æ–∂–µ–Ω–æ –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É.</div>
  `;

  currentPreviewDataUrl = "";

  // attach handlers (so they work after innerHTML replace)
  document.getElementById('cameraBtn').addEventListener('click', triggerCamera);
  document.getElementById('galleryBtn').addEventListener('click', triggerGallery);
  document.getElementById('coordsBtn').addEventListener('click', getCoords);
  document.getElementById('sendBtn').addEventListener('click', () => sendReport(addr));
}

/* Camera / gallery triggers ‚Äî handle iOS/Android quirks */
function triggerCamera(){
  // Prefer camera capture on Android. On iOS (in-app WebView) capture attribute often ignored or blocked,
  // so we remove capture there to allow user choice (works better).
  fileInput.accept = 'image/*';
  if (!isIOS()) {
    fileInput.setAttribute('capture','environment'); // Android generally supports this
  } else {
    fileInput.removeAttribute('capture'); // iOS Safari / WebView: let system choose
  }
  fileInput.click();
}
function triggerGallery(){
  fileInput.accept = 'image/*';
  fileInput.removeAttribute('capture');
  fileInput.click();
}

/* File input change -> read, draw timestamp on canvas, preview */
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  try {
    const dataUrl = await readFileAsDataURL(file);
    const watermarked = await addTimestampToImage(dataUrl);
    currentPreviewDataUrl = watermarked;
    showPreviewImage(watermarked);
    const coordText = document.getElementById('coordText');
    if (coordText && coordText.textContent.indexOf('–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ') === -1) {
      coordText.textContent = (coordText.textContent || '') + ' ‚Ä¢ –§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ';
    }
  } catch(err){
    alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: ' + err.message);
  } finally {
    fileInput.value = ""; // reset so same file can be selected again later
  }
});

function readFileAsDataURL(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function showPreviewImage(dataUrl){
  const prev = document.getElementById('photoPreview');
  prev.innerHTML = `<img src="${dataUrl}" alt="photo" />`;
}

/* Add timestamp on canvas (resize + watermark) */
async function addTimestampToImage(dataUrl){
  return new Promise((res, rej) => {
    const img = new Image();
    img.onload = () => {
      try {
        // Responsive resize
        const maxW = 1200;
        let w = img.width, h = img.height;
        if (w > maxW) {
          const ratio = maxW / w;
          w = Math.round(w * ratio);
          h = Math.round(h * ratio);
        }
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        // Timestamp
        const now = new Date();
        const ts = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

        // Font responsive
        const fontSize = Math.max(12, Math.round(w * 0.035));
        ctx.font = `${fontSize}px Arial`;
        ctx.textBaseline = 'bottom';
        const metrics = ctx.measureText(ts);
        const textW = metrics.width;
        const padding = Math.round(fontSize * 0.5);
        const x = w - textW - padding - 8;
        const y = h - 8;

        // Draw box
        const boxH = fontSize + padding;
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.fillRect(x - padding/1.2, y - boxH, textW + padding*2, boxH + 4);

        // Draw text
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        ctx.fillText(ts, x, y - 2);

        // toDataURL (jpeg)
        const out = canvas.toDataURL('image/jpeg', 0.8);
        res(out);
      } catch(e) { rej(e); }
    };
    img.onerror = () => rej(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏'));
    img.src = dataUrl;
  });
}
function pad(n){ return (n < 10 ? '0' : '') + n; }

/* Geolocation */
function getCoords(){
  const coordText = document.getElementById('coordText');
  if (!coordText) return;
  coordText.textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...';
  if (!navigator.geolocation){
    coordText.textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6);
    coordText.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat},${lon}`;
  }, err => {
    coordText.textContent = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ' + err.message;
  }, { enableHighAccuracy: true, timeout:10000 });
}

/* Send report - —Ç–µ—Å—Ç: –µ—Å–ª–∏ ?webhook= —É–∫–∞–∑–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∏—Ç POST */
async function sendReport(addr){
  const violation = document.getElementById('violationType').value;
  const comment = document.getElementById('comment').value;
  const coordText = document.getElementById('coordText');
  const coords = coordText ? (coordText.textContent.replace('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ','') || '') : '';
  if (!currentPreviewDataUrl){ alert('–î–æ–±–∞–≤—å —Ñ–æ—Ç–æ'); return; }

  const payload = {
    timestamp: new Date().toISOString(),
    type: selectedType,
    okrug: selectedOkrug,
    balance: selectedBalance,
    address: addr,
    violation,
    comment,
    coords,
    photo_base64: currentPreviewDataUrl
  };

  const webhook = "https://script.google.com/macros/s/AKfycbxUZYGtnjnv6wX7imt4wWsw1IHkOD-A_SNlUdY1yRfXksTF_gylle6mlgRZztNyPQ/exec";
  if (!webhook){
    console.log('Payload (test):', payload);
    alert('–î–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ (—Ç–µ—Å—Ç). –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–∫–∞–∂–∏ ?webhook=YOUR_URL –≤ —Å—Å—ã–ª–∫–µ –º–∏–Ω–∏-–∞–ø–ø–∞.');
    return;
  }

  try {
    const res = await fetch(webhook, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
    goBack();
  } catch(e){
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
  }
}

/* Utilities */
function getQueryParam(name){
  return new URLSearchParams(location.search).get(name);
}
function openExtra(name){ alert('–†–∞–∑–¥–µ–ª ¬´' + name + '¬ª –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.'); }
function escapeHtml(text){ return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* Init */
showStart();
</script>
</body>
</html>
